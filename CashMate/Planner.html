<?php
session_start();

include("connection.php");
include("functions.php");

// Get user data using check_login function
$user_data = check_login($con);

if ($_SERVER['REQUEST_METHOD'] == "POST") {
    // Something was posted
    $plan_name = mysqli_real_escape_string($con, $_POST['plan_name']);
    $goal = mysqli_real_escape_string($con, $_POST['goal']);
    $start_date = mysqli_real_escape_string($con, $_POST['start_date']);
    $end_date = mysqli_real_escape_string($con, $_POST['end_date']);
    $deposit = mysqli_real_escape_string($con, $_POST['deposit']);

    // Use prepared statement to prevent SQL injection
    $insert = $con->prepare("INSERT INTO planner (user_name, plan_name, goal, start_date, end_date, deposit) VALUES (?, ?, ?, ?, ?, ?)");
    $insert->bind_param("ssssss", $user_data['user_name'], $plan_name, $goal, $start_date, $end_date, $deposit);

		

    if ($insert->execute()) {
        // Record inserted successfully, now redirect to avoid form resubmission
        header("Location: " . $_SERVER['REQUEST_URI']);
        exit();
    } else {
        echo "Error: " . $insert->error;
    }

    $insert->close();
}



//$sql = "SELECT * FROM income WHERE user_name = '" . $user_data['user_name'] . "' ORDER BY date DESC LIMIT 8";
//$result = mysqli_query($con, $sql);
	
	// Store the results in an array
//$incomeData = [];
//while ($row = mysqli_fetch_assoc($result)) {
	//	$incomeData[] = $row;
//}
?>


<html lang="en">
  <head>
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> CASHMATE | Planner</title> 
	<link rel="icon" href="Images/CASHMATE.png" type="image/x-icon" width="50px" height="50px">
	<link type= "text/css" rel="stylesheet" href="CashMate.css"/>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"> </script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.js"></script>
	<script src="https://cdn.jsdelivr.net/gh/emn178/chartjs-plugin-labels/src/chartjs-plugin-labels.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

	<script src="income-page-js.js"></script>

  </head>
  <body>
		<nav class="navbar navbar-expand-lg "id="NavBar">
		<div class="container-fluid" id="cf">
			<div class="row" id="head">
				<div class="col-md-3">
					<div class="navbar-preheader">
						<h1 class="text-fluid"><img class="img-fluid" src="Images/CASHMATE.png"  alt="CashMate logo"><b> CASHMATE</b> </h1>
					  <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#drop-img">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>                        
					  </button> 
					</div>
				</div>
				<div class="col-md-9 collapse navbar-collapse navbar-right" id="drop-img">
					<ul class="nav navbar-nav "  >
						<li ><a href="Dashboard.html" class="link">Dashboard</a></li>
						<li><a href="Income page.html" class="link">Income</a></li>
						<li><a href="Spendings.html" class="link">Spendings</a></li>
						<li ><a href="Cards.html">Cards</a></li>
						<li ><a href="Planner.html" class="link">Planner</a></li> 
						<li ><a href="get-help.html" class="link"><img src="Images/question.png"></a></li> 
						<li ><a href="account-settings.html" class="link"><img src="Images/settings.png"></a></li> 
						<li ><a class="dropdown" data-toggle="dropdown"><img src="Images/male-user.png"></a>  
						  <ul class="dropdown-menu" style="background-color:rgb(140,195,126);">
							<li> <img src="Images/male-user.png" style="width:300px;height:300px;margin-left:60;margin-right:60;"></li>  
							<p style="margin-left:60;margin-right:60;">Username</p>
							<p >Username@example.com</p>
							<p style="margin-left:60;margin-right:60;" ><a href="login-page.html" onclick="signOut()">Sign-out</a></p>
						  </ul>
						</li> 
					 </ul>
					 
				</div>
		</div>
	</nav>
	<script>
    // JavaScript for handling sign-out
    function signOut() {
      // You can add additional logic here, such as clearing user session
      alert('Signing out...');
    }
  </script>
	<div class="container-fluid">
		<div class="row" id="Planner"> 
			<h1>Save for the Future!</h1> 
			<div class="col-md-12">
    <div class="planner-nav">
        <ul>
            <?php
            // Fetch planner data from the database
            $plannerSql = "SELECT DISTINCT plan_name FROM planner WHERE user_name = '" . $user_data['user_name'] . "'";
            $plannerResult = mysqli_query($con, $plannerSql);

            // Display planner links
            while ($planner = mysqli_fetch_assoc($plannerResult)) {
                echo '<li><a href="#">' . $planner['plan_name'] . '</a></li>';
            }
            ?>
            <li><button id="openPopupBtn" style="height:0;"><a href="#">+ add new </a></button></li>
        </ul>
    </div>
</div>

		</div>
	</div>
	<div class="container" style="margin-bottom:20px;" >
		<div class="col-md-4 retirement">
			 <h1> <img src="Images/retirement-icon.jpg" alt="Retirement Icon">Retirement</h1>
			 <p>P2,000,000 &nbsp;&nbsp;&nbsp;&nbsp;|<b>Target:P30,000,000.00</b></p> 
			 <div class="progress-bar-container">
                <div class="progress">
                    <div class="progress-bar-fill"></div>
                </div>
             </div>
			 <div>
				<p><b>Monthly Deposit:</b>  P50,000.00</p> 
                <p><b>Target Year:</b> 2076</p>
			 </div>
			<div class="deposit-btn text-center">
                <button onclick="deposit()">Deposit Now</button>
            </div>
		</div>
		<div class="col-md-7 retirement">
			<div class="deposit-history">
				<h1> Deposit History </h1>
			</div>
			<div class="deposit-record">
				<table class="table table-responsive-md deposit">
					<tbody>
						<tr>
						  <th scope="col"></th>
						  <th scope="col">Date</th>
						  <th scope="col">Mode</th>
						  <th scope="col">Amount</th>
						</tr>
						<tr>
							<td scope="row">Deposit</td>
							<td>11-08-03</td>
							<td>Card</td>
							<td>P550.21</td> 
						</tr>
						<tr>
							<td scope="row">Deposit</td>
							<td>10-8-03</td>
							<td>Card</td>
							<td>P1500.00</td> 
						</tr>
						<tr>
							<td scope="row">Deposit</td>
							<td>9-08-03</td>
							<td>E-payment</td>
							<td>P900.21</td> 
						</tr>
						<tr>
							<td scope="row">Deposit</td>
							<td>8-08-03</td>
							<td>Card</td>
							<td>P11000.00</td> 
						</tr>
						<tr>
							<td scope="row">Deposit</td>
							<td>7-08-03</td>
							<td>E-payment</td>
							<td>P300.00</td> 
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
	<div id="popupForm" class="popup">
    <form class="planner-container" method="POST">
        <h3>New Planner</h3>
        <label for="source">Planner Name:</label><br>
        <input type="text" placeholder="What do you want to save up for?" name="plan_name" required><br>

        <label for="category">Target Amount:</label><br>
        <input type="number" placeholder="Amount Goal" name="goal" id="goal" required><br>

        <label for="start_date">Start Date:</label><br>
        <input type="date" placeholder="January 21" name="start_date" id="start_date" required><br>

        <label for="date">Target year to accomplish:</label><br>
        <input type="date" placeholder="February 8" name="end_date" id="end_date" required><br>

        <button type="button" onclick="updateSuggestedDeposit()" class="btn-calculate" style="height:5%; border:3px solid #6ABA8C; border: radius 20px;">Calculate</button>

        <label for="amount">Suggested Monthly Deposit:</label><br>
        <input type="text" class="suggested-deposit">
				<input type="hidden" class="suggested-deposit-hidden" name="deposit">


        <button type="submit" class="btn-submit">Submit</button>
        <button type="button" class="btn-cancel" id="closePopupBtn" onclick="closeForm()">Close</button>
    </form>
</div>


<script type="text/javascript">
    const monthly = {
        displayValue: '0'
    };
    let monthlyDeposit = 0;

		function updateSuggestedDeposit() {
    var goal = document.getElementById("goal").value;
    var start_date = new Date(document.getElementById("start_date").value);
    var end_date = new Date(document.getElementById("end_date").value);

    // Ensure end_date is later than start_date
    if (end_date <= start_date) {
        alert("End date must be later than start date");
        return;
    }

    // Calculate remaining months between start_date and end_date
    var remainingMonths = (end_date.getFullYear() - start_date.getFullYear()) * 12 + end_date.getMonth() - start_date.getMonth();

    // Perform the same calculation logic as before
    var monthlyDeposit = Math.ceil(goal / remainingMonths);

    // Display the suggested deposit amount
    document.querySelector('.suggested-deposit').value = "P" + monthlyDeposit.toFixed(2);

		const hiddenInput = document.querySelector('.suggested-deposit-hidden');
    hiddenInput.value = monthlyDeposit.toFixed(2);
}


    function updateDisplay() {
        const display = document.querySelector('.suggested-deposit');
        display.value = "P" + monthlyDeposit.toFixed(2);
    }

    updateDisplay();

    function validateForm() {
        // You can add additional form validation logic here
        // Return true if the form is valid; otherwise, return false to prevent submission
        return true;
    }
</script>

<script src="income-page-js.js"></script>

	</body>
	<footer >
	<div class="container-fluid">
		<div class="row" id="footer">
			<div class="col-md-8">
				<div class="footer-clmn1">
				<h1>CashMate</h1>
				<p>Navigate Your Finances with Confidence</p>
			</div>
			</div>
			<div class="col-md-4">
				<div class="footer-clmn2">
				<p> STAY CONNECTED </p>
				<a href="#"><i class="fa fa-facebook fa-2x" style="color: white"></i></a>
				<a href="#"><i class="fa fa-twitter fa-2x" style="color: white"></i></a>
				<a href="#"><i class="fa fa-linkedin fa-2x" style="color: white"></i></a>
				<a href="#"><i class="fa fa-youtube fa-2x" style="color: white"></i></a>
				<a href="#"><i class="fa fa-envelope fa-2x" style="color: white"></i></a>
			</div>
		</div>
	</div>
	<div class="row" id="footer-b">
		<div class="col-md-6">
			<div class="footer-2clmn1">
				<p> Copyright 2023 © CashMate. All rights reserved.</p>
			</div>
		</div>
		<div class="col-md-6">
			<div class="footer-2clmn2">
				<p><a href="terms-conditions.html">Terms of Use </a>|<a href="privacy-policy.html"> Privacy Policy </a>|<a href="sitemap.html"> Site Map </a>|</p>
			</div>
		</div>
	</div>
  </footer>
</html>
